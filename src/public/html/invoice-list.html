<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice List - Smart Invoice Splitter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .invoice-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        .invoice-card:hover {
            border-left-color: #0056b3;
            box-shadow: 0 4px 12px rgba(0,123,255,0.15);
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .extraction-btn {
            min-width: 140px;
        }
        .page-range {
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .batch-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            min-width: 300px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .invoice-number {
            font-weight: 600;
            color: #495057;
        }
        .confidence-bar {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .confidence-high { background: #28a745; }
        .confidence-medium { background: #ffc107; }
        .confidence-low { background: #dc3545; }
        
        /* Table styling */
        .table th {
            border-top: none;
            font-weight: 600;
            font-size: 0.9rem;
            color: #495057;
        }
        .table td {
            vertical-align: middle;
            font-size: 0.9rem;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0,123,255,0.05);
        }
        
        /* Tab styling */
        .nav-pills .nav-link {
            border-radius: 6px;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        .nav-pills .nav-link.active {
            background-color: #007bff;
        }
        
        /* Progress bar in table */
        .progress {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="spinner-border text-primary mb-3"></div>
                <h5 id="loadingMessage">Extracting invoice data...</h5>
                <p class="text-muted mb-0">This may take a few moments</p>
            </div>
        </div>

        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="batch-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="mb-2">
                                <i class="fas fa-file-invoice-dollar me-2"></i>
                                Invoice List
                            </h1>
                            <p class="mb-0 opacity-75" id="batchInfo">Loading batch information...</p>
                        </div>
                        <div class="text-end">
                            <button class="btn btn-light btn-lg" onclick="goBack()">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Batch Statistics -->
        <div class="row mb-4" id="statsSection" style="display: none;">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-file-pdf fa-2x text-primary mb-2"></i>
                        <h4 class="mb-1" id="totalInvoices">0</h4>
                        <small class="text-muted">Total Invoices</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h4 class="mb-1" id="extractedCount">0</h4>
                        <small class="text-muted">Extracted</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                        <h4 class="mb-1" id="pendingCount">0</h4>
                        <small class="text-muted">Pending</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-percentage fa-2x text-info mb-2"></i>
                        <h4 class="mb-1" id="avgConfidence">0%</h4>
                        <small class="text-muted">Avg Confidence</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoice List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                Individual Invoices
                            </h5>
                            <!-- View Toggle Tabs -->
                            <ul class="nav nav-pills" id="viewTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="card-view-tab" data-bs-toggle="pill" data-bs-target="#card-view" type="button" role="tab">
                                        <i class="fas fa-th-large me-1"></i>Cards
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="table-view-tab" data-bs-toggle="pill" data-bs-target="#table-view" type="button" role="tab">
                                        <i class="fas fa-table me-1"></i>Table
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Tab Content -->
                        <div class="tab-content" id="viewTabContent">
                            <!-- Card View -->
                            <div class="tab-pane fade show active" id="card-view" role="tabpanel">
                                <div class="p-3" id="invoiceList">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary mb-3"></div>
                                        <p class="text-muted">Loading invoices...</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Table View -->
                            <div class="tab-pane fade" id="table-view" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0" id="invoiceTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th scope="col" style="width: 50px;">#</th>
                                                <th scope="col">Invoice Number</th>
                                                <th scope="col" style="width: 120px;">Page Range</th>
                                                <th scope="col" style="width: 100px;">Confidence</th>
                                                <th scope="col" style="width: 100px;">Status</th>
                                                <th scope="col" style="width: 200px;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="invoiceTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center py-5">
                                                    <div class="spinner-border text-primary mb-3"></div>
                                                    <p class="text-muted mb-0">Loading invoices...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Alert -->
        <div class="alert alert-danger" id="errorAlert" style="display: none;">
            <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
            <p id="errorMessage" class="mb-0"></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentBatchId = null;
        let invoiceData = [];
        let extractionStatus = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Get batch ID from URL path: /invoices/batchId
            const pathParts = window.location.pathname.split('/');
            currentBatchId = pathParts[pathParts.length - 1]; // Last part of the path
            
            if (!currentBatchId || currentBatchId === 'invoices') {
                showError('No batch ID provided');
                return;
            }

            loadBatchData();
        });

        async function loadBatchData() {
            try {
                const response = await fetch(`/api/batches/${currentBatchId}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                const batch = result.data;
                
                // Update batch info
                document.getElementById('batchInfo').textContent = 
                    `Batch: ${batch.originalFilename} • ${batch.totalPages} pages • Status: ${batch.status}`;

                // Load invoices
                if (batch.validatedSplits && batch.validatedSplits.length > 0) {
                    invoiceData = batch.validatedSplits;
                    
                    // Load existing extraction results from database
                    if (batch.extractedData) {
                        Object.keys(batch.extractedData).forEach(index => {
                            const result = batch.extractedData[index];
                            if (result.status === 'completed') {
                                extractionStatus[index] = 'extracted';
                                // Store the extraction result for viewing
                                invoiceData[index].extractionResult = result;
                            } else if (result.status === 'failed') {
                                extractionStatus[index] = 'error';
                                // Store the error for display
                                invoiceData[index].extractionError = result.error;
                            }
                        });
                    }
                    
                    renderInvoiceList();
                    renderInvoiceTable();
                    updateStatistics();
                    document.getElementById('statsSection').style.display = 'block';
                } else {
                    showError('No validated splits found. Please complete the splitting and validation process first.');
                }

            } catch (error) {
                console.error('Error loading batch data:', error);
                showError('Failed to load batch data: ' + error.message);
            }
        }

        function renderInvoiceList() {
            const container = document.getElementById('invoiceList');
            
            if (invoiceData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No invoices found</h5>
                        <p class="text-muted">Complete the splitting process to see individual invoices.</p>
                    </div>
                `;
                return;
            }

            const invoicesHtml = invoiceData.map((invoice, index) => {
                const isExtracted = extractionStatus[index] === 'extracted';
                const isExtracting = extractionStatus[index] === 'extracting';
                const confidence = invoice.confidence || 0.85;
                const confidencePercent = Math.round(confidence * 100);
                
                let confidenceClass = 'confidence-high';
                if (confidence < 0.7) confidenceClass = 'confidence-low';
                else if (confidence < 0.85) confidenceClass = 'confidence-medium';

                return `
                    <div class="invoice-card card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-file-invoice fa-2x text-primary"></i>
                                        </div>
                                        <div>
                                            <h6 class="invoice-number mb-1">${invoice.invoiceNumber || `Invoice ${index + 1}`}</h6>
                                            <div class="page-range">Pages ${invoice.startPage}-${invoice.endPage}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted d-block">Confidence</small>
                                    <div class="confidence-bar mb-1">
                                        <div class="confidence-fill ${confidenceClass}" style="width: ${confidencePercent}%"></div>
                                    </div>
                                    <small class="text-muted">${confidencePercent}%</small>
                                </div>
                                <div class="col-md-2">
                                    ${isExtracted ? 
                                        '<span class="badge bg-success status-badge"><i class="fas fa-check me-1"></i>Extracted</span>' :
                                        extractionStatus[index] === 'error' ?
                                        '<span class="badge bg-danger status-badge"><i class="fas fa-exclamation-triangle me-1"></i>Error</span>' :
                                        '<span class="badge bg-secondary status-badge"><i class="fas fa-clock me-1"></i>Pending</span>'
                                    }
                                </div>
                                <div class="col-md-3 text-end">
                                    ${isExtracted ?
                                        `<button class="btn btn-outline-primary extraction-btn" onclick="viewExtraction(${index})">
                                            <i class="fas fa-eye me-2"></i>View Results
                                        </button>` :
                                        extractionStatus[index] === 'error' ?
                                        `<button class="btn btn-warning extraction-btn" onclick="extractInvoice(${index})">
                                            <i class="fas fa-redo me-2"></i>Retry Extraction
                                        </button>` :
                                        `<button class="btn btn-primary extraction-btn" onclick="extractInvoice(${index})" ${isExtracting ? 'disabled' : ''}>
                                            ${isExtracting ? 
                                                '<span class="spinner-border spinner-border-sm me-2"></span>Extracting...' :
                                                '<i class="fas fa-magic me-2"></i>Extract Data'
                                            }
                                        </button>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = invoicesHtml;
        }

        function renderInvoiceTable() {
            const tableBody = document.getElementById('invoiceTableBody');
            
            if (invoiceData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No invoices found</h5>
                            <p class="text-muted mb-0">Complete the splitting process to see individual invoices.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const tableRowsHtml = invoiceData.map((invoice, index) => {
                const isExtracted = extractionStatus[index] === 'extracted';
                const isExtracting = extractionStatus[index] === 'extracting';
                const hasError = extractionStatus[index] === 'error';
                const confidence = invoice.confidence || 0.85;
                const confidencePercent = Math.round(confidence * 100);
                
                let statusBadge = '';
                let actionButton = '';
                
                if (isExtracted) {
                    statusBadge = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Extracted</span>';
                    actionButton = `<button class="btn btn-outline-primary btn-sm" onclick="viewExtraction(${index})">
                        <i class="fas fa-eye me-1"></i>View Results
                    </button>`;
                } else if (hasError) {
                    statusBadge = '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error</span>';
                    actionButton = `<button class="btn btn-warning btn-sm" onclick="extractInvoice(${index})">
                        <i class="fas fa-redo me-1"></i>Retry
                    </button>`;
                } else if (isExtracting) {
                    statusBadge = '<span class="badge bg-info"><i class="fas fa-spinner fa-spin me-1"></i>Processing</span>';
                    actionButton = `<button class="btn btn-primary btn-sm" disabled>
                        <span class="spinner-border spinner-border-sm me-1"></span>Extracting...
                    </button>`;
                } else {
                    statusBadge = '<span class="badge bg-secondary"><i class="fas fa-clock me-1"></i>Pending</span>';
                    actionButton = `<button class="btn btn-primary btn-sm" onclick="extractInvoice(${index})">
                        <i class="fas fa-magic me-1"></i>Extract Data
                    </button>`;
                }

                return `
                    <tr class="${isExtracting ? 'table-info' : hasError ? 'table-warning' : isExtracted ? 'table-success' : ''}">
                        <td class="text-center fw-bold">${index + 1}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-invoice text-primary me-2"></i>
                                <span class="fw-medium">${invoice.invoiceNumber || `Invoice ${index + 1}`}</span>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">
                                Pages ${invoice.startPage}-${invoice.endPage}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress me-2" style="width: 60px; height: 8px;">
                                    <div class="progress-bar ${confidence >= 0.85 ? 'bg-success' : confidence >= 0.7 ? 'bg-warning' : 'bg-danger'}" 
                                         style="width: ${confidencePercent}%"></div>
                                </div>
                                <small class="text-muted">${confidencePercent}%</small>
                            </div>
                        </td>
                        <td>${statusBadge}</td>
                        <td>${actionButton}</td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = tableRowsHtml;
        }

        async function extractInvoice(invoiceIndex) {
            try {
                // Update UI to show extracting state
                extractionStatus[invoiceIndex] = 'extracting';
                renderInvoiceList();
                renderInvoiceTable();
                
                // Show loading overlay
                document.getElementById('loadingMessage').textContent = 
                    `Extracting data from ${invoiceData[invoiceIndex].invoiceNumber || `Invoice ${invoiceIndex + 1}`}...`;
                document.getElementById('loadingOverlay').style.display = 'flex';

                const response = await fetch(`/api/batches/${currentBatchId}/extract-invoice/${invoiceIndex}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                // Store extraction result
                extractionStatus[invoiceIndex] = 'extracted';
                invoiceData[invoiceIndex].extractionResult = result.data;

                // Update UI
                renderInvoiceList();
                renderInvoiceTable();
                updateStatistics();

                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';

                // Show success message
                showSuccess(`Successfully extracted data from ${invoiceData[invoiceIndex].invoiceNumber || `Invoice ${invoiceIndex + 1}`}`);

            } catch (error) {
                console.error('Extraction error:', error);
                extractionStatus[invoiceIndex] = 'error';
                
                // Store the error message for display
                invoiceData[invoiceIndex].extractionError = error.message;
                
                renderInvoiceList();
                renderInvoiceTable();
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Show specific error message
                let errorMsg = 'Extraction failed';
                if (error.message.includes('token limit') || error.message.includes('Token limit')) {
                    errorMsg = 'Document too large for AI processing. Try processing fewer pages or a simpler document.';
                } else if (error.message.includes('rate limit')) {
                    errorMsg = 'API rate limit exceeded. Please wait before retrying.';
                } else if (error.message.includes('quota')) {
                    errorMsg = 'API quota exceeded. Check your Azure OpenAI limits.';
                } else {
                    errorMsg = 'Extraction failed: ' + error.message;
                }
                
                showError(errorMsg);
            }
        }

        function viewExtraction(invoiceIndex) {
            const invoice = invoiceData[invoiceIndex];
            if (invoice.extractionResult) {
                // Open extraction results in new window with the stored data
                const url = `/static/html/extract-results.html?batchId=${currentBatchId}&invoiceIndex=${invoiceIndex}`;
                window.open(url, '_blank');
            } else {
                showError('No extraction results found for this invoice.');
            }
        }

        function updateStatistics() {
            const total = invoiceData.length;
            const extracted = Object.values(extractionStatus).filter(status => status === 'extracted').length;
            const pending = total - extracted;
            
            // Calculate average confidence
            let totalConfidence = 0;
            let confidenceCount = 0;
            invoiceData.forEach(invoice => {
                if (invoice.confidence) {
                    totalConfidence += invoice.confidence;
                    confidenceCount++;
                }
            });
            const avgConfidence = confidenceCount > 0 ? Math.round((totalConfidence / confidenceCount) * 100) : 0;

            document.getElementById('totalInvoices').textContent = total;
            document.getElementById('extractedCount').textContent = extracted;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('avgConfidence').textContent = avgConfidence + '%';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorAlert').style.display = 'block';
            document.getElementById('invoiceList').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <h5 class="text-danger">Error</h5>
                    <p class="text-muted">${message}</p>
                </div>
            `;
        }

        function showSuccess(message) {
            // Create and show success toast
            const toastHtml = `
                <div class="toast align-items-center text-white bg-success border-0" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 1055;">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-check-circle me-2"></i>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.body.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        function goBack() {
            window.location.href = '/';
        }
    </script>
</body>
</html>
